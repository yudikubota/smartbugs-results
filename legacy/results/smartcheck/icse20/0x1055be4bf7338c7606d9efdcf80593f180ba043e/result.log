/unique_chucks/6/0x1055be4bf7338c7606d9efdcf80593f180ba043e.sol
jar:file:/usr/local/lib/node_modules/@smartdec/smartcheck/jdeploy-bundle/smartcheck-2.0-jar-with-dependencies.jar!/solidity-rules.xmlruleId: SOLIDITY_ADDRESS_HARDCODED
patternId: a91b18
severity: 1
line: 1182
column: 35
content: (address(0))

ruleId: SOLIDITY_EXTRA_GAS_IN_LOOPS
patternId: d3j11j
severity: 1
line: 922
column: 8
content: for(uinti=0;i<collateralMarkets.length;i++){if(collateralMarkets[i]==asset){return;}}

ruleId: SOLIDITY_GAS_LIMIT_IN_LOOPS
patternId: f6f853
severity: 2
line: 922
column: 8
content: for(uinti=0;i<collateralMarkets.length;i++){if(collateralMarkets[i]==asset){return;}}

ruleId: SOLIDITY_LOCKED_MONEY
patternId: 30281d
severity: 3
line: 664
column: 0
content: contractMoneyMarketisExponential,SafeToken{uintconstantinitialInterestIndex=10**18;uintconstantdefaultOriginationFee=0;uintconstantminimumCollateralRatioMantissa=11*(10**17);uintconstantmaximumLiquidationDiscountMantissa=(10**17);constructor()public{admin=msg.sender;collateralRatio=Exp({mantissa:2*mantissaOne});originationFee=Exp({mantissa:defaultOriginationFee});liquidationDiscount=Exp({mantissa:0});}function()payablepublic{revert();}addresspublicpendingAdmin;addresspublicadmin;addresspublicoracle;structBalance{uintprincipal;uintinterestIndex;}mapping(address=>mapping(address=>Balance))publicsupplyBalances;mapping(address=>mapping(address=>Balance))publicborrowBalances;structMarket{boolisSupported;uintblockNumber;InterestRateModelinterestRateModel;uinttotalSupply;uintsupplyRateMantissa;uintsupplyIndex;uinttotalBorrows;uintborrowRateMantissa;uintborrowIndex;}mapping(address=>Market)publicmarkets;address[]publiccollateralMarkets;ExppubliccollateralRatio;ExppublicoriginationFee;ExppublicliquidationDiscount;boolpublicpaused;eventSupplyReceived(addressaccount,addressasset,uintamount,uintstartingBalance,uintnewBalance);eventSupplyWithdrawn(addressaccount,addressasset,uintamount,uintstartingBalance,uintnewBalance);eventBorrowTaken(addressaccount,addressasset,uintamount,uintstartingBalance,uintborrowAmountWithFee,uintnewBalance);eventBorrowRepaid(addressaccount,addressasset,uintamount,uintstartingBalance,uintnewBalance);eventBorrowLiquidated(addresstargetAccount,addressassetBorrow,uintborrowBalanceBefore,uintborrowBalanceAccumulated,uintamountRepaid,uintborrowBalanceAfter,addressliquidator,addressassetCollateral,uintcollateralBalanceBefore,uintcollateralBalanceAccumulated,uintamountSeized,uintcollateralBalanceAfter);eventNewPendingAdmin(addressoldPendingAdmin,addressnewPendingAdmin);eventNewAdmin(addressoldAdmin,addressnewAdmin);eventNewOracle(addressoldOracle,addressnewOracle);eventSupportedMarket(addressasset,addressinterestRateModel);eventNewRiskParameters(uintoldCollateralRatioMantissa,uintnewCollateralRatioMantissa,uintoldLiquidationDiscountMantissa,uintnewLiquidationDiscountMantissa);eventNewOriginationFee(uintoldOriginationFeeMantissa,uintnewOriginationFeeMantissa);eventSetMarketInterestRateModel(addressasset,addressinterestRateModel);eventEquityWithdrawn(addressasset,uintequityAvailableBefore,uintamount,addressowner);eventSuspendedMarket(addressasset);eventSetPaused(boolnewState);functionmin(uinta,uintb)pureinternalreturns(uint){if(a<b){returna;}else{returnb;}}functiongetBlockNumber()internalviewreturns(uint){returnblock.number;}functionaddCollateralMarket(addressasset)internal{for(uinti=0;i<collateralMarkets.length;i++){if(collateralMarkets[i]==asset){return;}}collateralMarkets.push(asset);}functiongetCollateralMarketsLength()publicviewreturns(uint){returncollateralMarkets.length;}functioncalculateInterestIndex(uintstartingInterestIndex,uintinterestRateMantissa,uintblockStart,uintblockEnd)pureinternalreturns(Error,uint){(Errorerr0,uintblockDelta)=sub(blockEnd,blockStart);if(err0!=Error.NO_ERROR){return(err0,0);}(Errorerr1,ExpmemoryblocksTimesRate)=mulScalar(Exp({mantissa:interestRateMantissa}),blockDelta);if(err1!=Error.NO_ERROR){return(err1,0);}(Errorerr2,ExpmemoryonePlusBlocksTimesRate)=addExp(blocksTimesRate,Exp({mantissa:mantissaOne}));if(err2!=Error.NO_ERROR){return(err2,0);}(Errorerr3,ExpmemorynewInterestIndexExp)=mulScalar(onePlusBlocksTimesRate,startingInterestIndex);if(err3!=Error.NO_ERROR){return(err3,0);}return(Error.NO_ERROR,truncate(newInterestIndexExp));}functioncalculateBalance(uintstartingBalance,uintinterestIndexStart,uintinterestIndexEnd)pureinternalreturns(Error,uint){if(startingBalance==0){return(Error.NO_ERROR,0);}(Errorerr0,uintbalanceTimesIndex)=mul(startingBalance,interestIndexEnd);if(err0!=Error.NO_ERROR){return(err0,0);}returndiv(balanceTimesIndex,interestIndexStart);}functiongetPriceForAssetAmount(addressasset,uintassetAmount)internalviewreturns(Error,Expmemory){(Errorerr,ExpmemoryassetPrice)=fetchAssetPrice(asset);if(err!=Error.NO_ERROR){return(err,Exp({mantissa:0}));}if(isZeroExp(assetPrice)){return(Error.MISSING_ASSET_PRICE,Exp({mantissa:0}));}returnmulScalar(assetPrice,assetAmount);}functiongetPriceForAssetAmountMulCollatRatio(addressasset,uintassetAmount)internalviewreturns(Error,Expmemory){Errorerr;ExpmemoryassetPrice;ExpmemoryscaledPrice;(err,assetPrice)=fetchAssetPrice(asset);if(err!=Error.NO_ERROR){return(err,Exp({mantissa:0}));}if(isZeroExp(assetPrice)){return(Error.MISSING_ASSET_PRICE,Exp({mantissa:0}));}(err,scaledPrice)=mulExp(collateralRatio,assetPrice);if(err!=Error.NO_ERROR){return(err,Exp({mantissa:0}));}returnmulScalar(scaledPrice,assetAmount);}functioncalculateBorrowAmountWithFee(uintborrowAmount)viewinternalreturns(Error,uint){if(isZeroExp(originationFee)){return(Error.NO_ERROR,borrowAmount);}(Errorerr0,ExpmemoryoriginationFeeFactor)=addExp(originationFee,Exp({mantissa:mantissaOne}));if(err0!=Error.NO_ERROR){return(err0,0);}(Errorerr1,ExpmemoryborrowAmountWithFee)=mulScalar(originationFeeFactor,borrowAmount);if(err1!=Error.NO_ERROR){return(err1,0);}return(Error.NO_ERROR,truncate(borrowAmountWithFee));}functionfetchAssetPrice(addressasset)internalviewreturns(Error,Expmemory){if(oracle==address(0)){return(Error.ZERO_ORACLE_ADDRESS,Exp({mantissa:0}));}PriceOracleInterfaceoracleInterface=PriceOracleInterface(oracle);uintpriceMantissa=oracleInterface.assetPrices(asset);return(Error.NO_ERROR,Exp({mantissa:priceMantissa}));}functionassetPrices(addressasset)publicviewreturns(uint){(Errorerr,Expmemoryresult)=fetchAssetPrice(asset);if(err!=Error.NO_ERROR){return0;}returnresult.mantissa;}functiongetAssetAmountForValue(addressasset,ExpethValue)internalviewreturns(Error,uint){Errorerr;ExpmemoryassetPrice;ExpmemoryassetAmount;(err,assetPrice)=fetchAssetPrice(asset);if(err!=Error.NO_ERROR){return(err,0);}(err,assetAmount)=divExp(ethValue,assetPrice);if(err!=Error.NO_ERROR){return(err,0);}return(Error.NO_ERROR,truncate(assetAmount));}function_setPendingAdmin(addressnewPendingAdmin)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SET_PENDING_ADMIN_OWNER_CHECK);}addressoldPendingAdmin=pendingAdmin;pendingAdmin=newPendingAdmin;emitNewPendingAdmin(oldPendingAdmin,newPendingAdmin);returnuint(Error.NO_ERROR);}function_acceptAdmin()publicreturns(uint){if(msg.sender!=pendingAdmin){returnfail(Error.UNAUTHORIZED,FailureInfo.ACCEPT_ADMIN_PENDING_ADMIN_CHECK);}addressoldAdmin=admin;admin=pendingAdmin;pendingAdmin=0;emitNewAdmin(oldAdmin,msg.sender);returnuint(Error.NO_ERROR);}function_setOracle(addressnewOracle)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SET_ORACLE_OWNER_CHECK);}PriceOracleInterfaceoracleInterface=PriceOracleInterface(newOracle);oracleInterface.assetPrices(address(0));addressoldOracle=oracle;oracle=newOracle;emitNewOracle(oldOracle,newOracle);returnuint(Error.NO_ERROR);}function_setPaused(boolrequestedState)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SET_PAUSED_OWNER_CHECK);}paused=requestedState;emitSetPaused(requestedState);returnuint(Error.NO_ERROR);}functiongetAccountLiquidity(addressaccount)publicviewreturns(int){(Errorerr,ExpmemoryaccountLiquidity,ExpmemoryaccountShortfall)=calculateAccountLiquidity(account);require(err==Error.NO_ERROR);if(isZeroExp(accountLiquidity)){return-1*int(truncate(accountShortfall));}else{returnint(truncate(accountLiquidity));}}functiongetSupplyBalance(addressaccount,addressasset)viewpublicreturns(uint){Errorerr;uintnewSupplyIndex;uintuserSupplyCurrent;Marketstoragemarket=markets[asset];BalancestoragesupplyBalance=supplyBalances[account][asset];(err,newSupplyIndex)=calculateInterestIndex(market.supplyIndex,market.supplyRateMantissa,market.blockNumber,getBlockNumber());require(err==Error.NO_ERROR);(err,userSupplyCurrent)=calculateBalance(supplyBalance.principal,supplyBalance.interestIndex,newSupplyIndex);require(err==Error.NO_ERROR);returnuserSupplyCurrent;}functiongetBorrowBalance(addressaccount,addressasset)viewpublicreturns(uint){Errorerr;uintnewBorrowIndex;uintuserBorrowCurrent;Marketstoragemarket=markets[asset];BalancestorageborrowBalance=borrowBalances[account][asset];(err,newBorrowIndex)=calculateInterestIndex(market.borrowIndex,market.borrowRateMantissa,market.blockNumber,getBlockNumber());require(err==Error.NO_ERROR);(err,userBorrowCurrent)=calculateBalance(borrowBalance.principal,borrowBalance.interestIndex,newBorrowIndex);require(err==Error.NO_ERROR);returnuserBorrowCurrent;}function_supportMarket(addressasset,InterestRateModelinterestRateModel)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SUPPORT_MARKET_OWNER_CHECK);}(Errorerr,ExpmemoryassetPrice)=fetchAssetPrice(asset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPORT_MARKET_FETCH_PRICE_FAILED);}if(isZeroExp(assetPrice)){returnfail(Error.ASSET_NOT_PRICED,FailureInfo.SUPPORT_MARKET_PRICE_CHECK);}markets[asset].interestRateModel=interestRateModel;addCollateralMarket(asset);markets[asset].isSupported=true;if(markets[asset].supplyIndex==0){markets[asset].supplyIndex=initialInterestIndex;}if(markets[asset].borrowIndex==0){markets[asset].borrowIndex=initialInterestIndex;}emitSupportedMarket(asset,interestRateModel);returnuint(Error.NO_ERROR);}function_suspendMarket(addressasset)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SUSPEND_MARKET_OWNER_CHECK);}if(!markets[asset].isSupported){returnuint(Error.NO_ERROR);}markets[asset].isSupported=false;emitSuspendedMarket(asset);returnuint(Error.NO_ERROR);}function_setRiskParameters(uintcollateralRatioMantissa,uintliquidationDiscountMantissa)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SET_RISK_PARAMETERS_OWNER_CHECK);}ExpmemorynewCollateralRatio=Exp({mantissa:collateralRatioMantissa});ExpmemorynewLiquidationDiscount=Exp({mantissa:liquidationDiscountMantissa});ExpmemoryminimumCollateralRatio=Exp({mantissa:minimumCollateralRatioMantissa});ExpmemorymaximumLiquidationDiscount=Exp({mantissa:maximumLiquidationDiscountMantissa});Errorerr;ExpmemorynewLiquidationDiscountPlusOne;if(lessThanExp(newCollateralRatio,minimumCollateralRatio)){returnfail(Error.INVALID_COLLATERAL_RATIO,FailureInfo.SET_RISK_PARAMETERS_VALIDATION);}if(lessThanExp(maximumLiquidationDiscount,newLiquidationDiscount)){returnfail(Error.INVALID_LIQUIDATION_DISCOUNT,FailureInfo.SET_RISK_PARAMETERS_VALIDATION);}(err,newLiquidationDiscountPlusOne)=addExp(newLiquidationDiscount,Exp({mantissa:mantissaOne}));assert(err==Error.NO_ERROR);if(lessThanOrEqualExp(newCollateralRatio,newLiquidationDiscountPlusOne)){returnfail(Error.INVALID_COMBINED_RISK_PARAMETERS,FailureInfo.SET_RISK_PARAMETERS_VALIDATION);}ExpmemoryoldCollateralRatio=collateralRatio;ExpmemoryoldLiquidationDiscount=liquidationDiscount;collateralRatio=newCollateralRatio;liquidationDiscount=newLiquidationDiscount;emitNewRiskParameters(oldCollateralRatio.mantissa,collateralRatioMantissa,oldLiquidationDiscount.mantissa,liquidationDiscountMantissa);returnuint(Error.NO_ERROR);}function_setOriginationFee(uintoriginationFeeMantissa)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SET_ORIGINATION_FEE_OWNER_CHECK);}ExpmemoryoldOriginationFee=originationFee;originationFee=Exp({mantissa:originationFeeMantissa});emitNewOriginationFee(oldOriginationFee.mantissa,originationFeeMantissa);returnuint(Error.NO_ERROR);}function_setMarketInterestRateModel(addressasset,InterestRateModelinterestRateModel)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.SET_MARKET_INTEREST_RATE_MODEL_OWNER_CHECK);}markets[asset].interestRateModel=interestRateModel;emitSetMarketInterestRateModel(asset,interestRateModel);returnuint(Error.NO_ERROR);}function_withdrawEquity(addressasset,uintamount)publicreturns(uint){if(msg.sender!=admin){returnfail(Error.UNAUTHORIZED,FailureInfo.EQUITY_WITHDRAWAL_MODEL_OWNER_CHECK);}uintcash=getCash(asset);(Errorerr0,uintequity)=addThenSub(cash,markets[asset].totalBorrows,markets[asset].totalSupply);if(err0!=Error.NO_ERROR){returnfail(err0,FailureInfo.EQUITY_WITHDRAWAL_CALCULATE_EQUITY);}if(amount>equity){returnfail(Error.EQUITY_INSUFFICIENT_BALANCE,FailureInfo.EQUITY_WITHDRAWAL_AMOUNT_VALIDATION);}Errorerr2=doTransferOut(asset,admin,amount);if(err2!=Error.NO_ERROR){returnfail(err2,FailureInfo.EQUITY_WITHDRAWAL_TRANSFER_OUT_FAILED);}emitEquityWithdrawn(asset,equity,amount,admin);returnuint(Error.NO_ERROR);}structSupplyLocalVars{uintstartingBalance;uintnewSupplyIndex;uintuserSupplyCurrent;uintuserSupplyUpdated;uintnewTotalSupply;uintcurrentCash;uintupdatedCash;uintnewSupplyRateMantissa;uintnewBorrowIndex;uintnewBorrowRateMantissa;}functionsupply(addressasset,uintamount)publicreturns(uint){if(paused){returnfail(Error.CONTRACT_PAUSED,FailureInfo.SUPPLY_CONTRACT_PAUSED);}Marketstoragemarket=markets[asset];Balancestoragebalance=supplyBalances[msg.sender][asset];SupplyLocalVarsmemorylocalResults;Errorerr;uintrateCalculationResultCode;if(!market.isSupported){returnfail(Error.MARKET_NOT_SUPPORTED,FailureInfo.SUPPLY_MARKET_NOT_SUPPORTED);}err=checkTransferIn(asset,msg.sender,amount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_TRANSFER_IN_NOT_POSSIBLE);}(err,localResults.newSupplyIndex)=calculateInterestIndex(market.supplyIndex,market.supplyRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_NEW_SUPPLY_INDEX_CALCULATION_FAILED);}(err,localResults.userSupplyCurrent)=calculateBalance(balance.principal,balance.interestIndex,localResults.newSupplyIndex);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_ACCUMULATED_BALANCE_CALCULATION_FAILED);}(err,localResults.userSupplyUpdated)=add(localResults.userSupplyCurrent,amount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_NEW_TOTAL_BALANCE_CALCULATION_FAILED);}(err,localResults.newTotalSupply)=addThenSub(market.totalSupply,localResults.userSupplyUpdated,balance.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_NEW_TOTAL_SUPPLY_CALCULATION_FAILED);}localResults.currentCash=getCash(asset);(err,localResults.updatedCash)=add(localResults.currentCash,amount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_NEW_TOTAL_CASH_CALCULATION_FAILED);}(rateCalculationResultCode,localResults.newSupplyRateMantissa)=market.interestRateModel.getSupplyRate(asset,localResults.updatedCash,market.totalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.SUPPLY_NEW_SUPPLY_RATE_CALCULATION_FAILED,rateCalculationResultCode);}(err,localResults.newBorrowIndex)=calculateInterestIndex(market.borrowIndex,market.borrowRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_NEW_BORROW_INDEX_CALCULATION_FAILED);}(rateCalculationResultCode,localResults.newBorrowRateMantissa)=market.interestRateModel.getBorrowRate(asset,localResults.updatedCash,market.totalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.SUPPLY_NEW_BORROW_RATE_CALCULATION_FAILED,rateCalculationResultCode);}err=doTransferIn(asset,msg.sender,amount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.SUPPLY_TRANSFER_IN_FAILED);}market.blockNumber=getBlockNumber();market.totalSupply=localResults.newTotalSupply;market.supplyRateMantissa=localResults.newSupplyRateMantissa;market.supplyIndex=localResults.newSupplyIndex;market.borrowRateMantissa=localResults.newBorrowRateMantissa;market.borrowIndex=localResults.newBorrowIndex;localResults.startingBalance=balance.principal;balance.principal=localResults.userSupplyUpdated;balance.interestIndex=localResults.newSupplyIndex;emitSupplyReceived(msg.sender,asset,amount,localResults.startingBalance,localResults.userSupplyUpdated);returnuint(Error.NO_ERROR);}structWithdrawLocalVars{uintwithdrawAmount;uintstartingBalance;uintnewSupplyIndex;uintuserSupplyCurrent;uintuserSupplyUpdated;uintnewTotalSupply;uintcurrentCash;uintupdatedCash;uintnewSupplyRateMantissa;uintnewBorrowIndex;uintnewBorrowRateMantissa;ExpaccountLiquidity;ExpaccountShortfall;ExpethValueOfWithdrawal;uintwithdrawCapacity;}functionwithdraw(addressasset,uintrequestedAmount)publicreturns(uint){if(paused){returnfail(Error.CONTRACT_PAUSED,FailureInfo.WITHDRAW_CONTRACT_PAUSED);}Marketstoragemarket=markets[asset];BalancestoragesupplyBalance=supplyBalances[msg.sender][asset];WithdrawLocalVarsmemorylocalResults;Errorerr;uintrateCalculationResultCode;(err,localResults.accountLiquidity,localResults.accountShortfall)=calculateAccountLiquidity(msg.sender);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_ACCOUNT_LIQUIDITY_CALCULATION_FAILED);}(err,localResults.newSupplyIndex)=calculateInterestIndex(market.supplyIndex,market.supplyRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_NEW_SUPPLY_INDEX_CALCULATION_FAILED);}(err,localResults.userSupplyCurrent)=calculateBalance(supplyBalance.principal,supplyBalance.interestIndex,localResults.newSupplyIndex);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_ACCUMULATED_BALANCE_CALCULATION_FAILED);}if(requestedAmount==uint(-1)){(err,localResults.withdrawCapacity)=getAssetAmountForValue(asset,localResults.accountLiquidity);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_CAPACITY_CALCULATION_FAILED);}localResults.withdrawAmount=min(localResults.withdrawCapacity,localResults.userSupplyCurrent);}else{localResults.withdrawAmount=requestedAmount;}localResults.currentCash=getCash(asset);(err,localResults.updatedCash)=sub(localResults.currentCash,localResults.withdrawAmount);if(err!=Error.NO_ERROR){returnfail(Error.TOKEN_INSUFFICIENT_CASH,FailureInfo.WITHDRAW_TRANSFER_OUT_NOT_POSSIBLE);}(err,localResults.userSupplyUpdated)=sub(localResults.userSupplyCurrent,localResults.withdrawAmount);if(err!=Error.NO_ERROR){returnfail(Error.INSUFFICIENT_BALANCE,FailureInfo.WITHDRAW_NEW_TOTAL_BALANCE_CALCULATION_FAILED);}if(!isZeroExp(localResults.accountShortfall)){returnfail(Error.INSUFFICIENT_LIQUIDITY,FailureInfo.WITHDRAW_ACCOUNT_SHORTFALL_PRESENT);}(err,localResults.ethValueOfWithdrawal)=getPriceForAssetAmount(asset,localResults.withdrawAmount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_AMOUNT_VALUE_CALCULATION_FAILED);}if(lessThanExp(localResults.accountLiquidity,localResults.ethValueOfWithdrawal)){returnfail(Error.INSUFFICIENT_LIQUIDITY,FailureInfo.WITHDRAW_AMOUNT_LIQUIDITY_SHORTFALL);}(err,localResults.newTotalSupply)=addThenSub(market.totalSupply,localResults.userSupplyUpdated,supplyBalance.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_NEW_TOTAL_SUPPLY_CALCULATION_FAILED);}(rateCalculationResultCode,localResults.newSupplyRateMantissa)=market.interestRateModel.getSupplyRate(asset,localResults.updatedCash,market.totalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.WITHDRAW_NEW_SUPPLY_RATE_CALCULATION_FAILED,rateCalculationResultCode);}(err,localResults.newBorrowIndex)=calculateInterestIndex(market.borrowIndex,market.borrowRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_NEW_BORROW_INDEX_CALCULATION_FAILED);}(rateCalculationResultCode,localResults.newBorrowRateMantissa)=market.interestRateModel.getBorrowRate(asset,localResults.updatedCash,market.totalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.WITHDRAW_NEW_BORROW_RATE_CALCULATION_FAILED,rateCalculationResultCode);}err=doTransferOut(asset,msg.sender,localResults.withdrawAmount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.WITHDRAW_TRANSFER_OUT_FAILED);}market.blockNumber=getBlockNumber();market.totalSupply=localResults.newTotalSupply;market.supplyRateMantissa=localResults.newSupplyRateMantissa;market.supplyIndex=localResults.newSupplyIndex;market.borrowRateMantissa=localResults.newBorrowRateMantissa;market.borrowIndex=localResults.newBorrowIndex;localResults.startingBalance=supplyBalance.principal;supplyBalance.principal=localResults.userSupplyUpdated;supplyBalance.interestIndex=localResults.newSupplyIndex;emitSupplyWithdrawn(msg.sender,asset,localResults.withdrawAmount,localResults.startingBalance,localResults.userSupplyUpdated);returnuint(Error.NO_ERROR);}structAccountValueLocalVars{addressassetAddress;uintcollateralMarketsLength;uintnewSupplyIndex;uintuserSupplyCurrent;ExpsupplyTotalValue;ExpsumSupplies;uintnewBorrowIndex;uintuserBorrowCurrent;ExpborrowTotalValue;ExpsumBorrows;}functioncalculateAccountLiquidity(addressuserAddress)internalviewreturns(Error,Expmemory,Expmemory){Errorerr;uintsumSupplyValuesMantissa;uintsumBorrowValuesMantissa;(err,sumSupplyValuesMantissa,sumBorrowValuesMantissa)=calculateAccountValuesInternal(userAddress);if(err!=Error.NO_ERROR){return(err,Exp({mantissa:0}),Exp({mantissa:0}));}Expmemoryresult;ExpmemorysumSupplyValuesFinal=Exp({mantissa:sumSupplyValuesMantissa});ExpmemorysumBorrowValuesFinal;(err,sumBorrowValuesFinal)=mulExp(collateralRatio,Exp({mantissa:sumBorrowValuesMantissa}));if(err!=Error.NO_ERROR){return(err,Exp({mantissa:0}),Exp({mantissa:0}));}if(lessThanExp(sumSupplyValuesFinal,sumBorrowValuesFinal)){(err,result)=subExp(sumBorrowValuesFinal,sumSupplyValuesFinal);assert(err==Error.NO_ERROR);return(Error.NO_ERROR,Exp({mantissa:0}),result);}else{(err,result)=subExp(sumSupplyValuesFinal,sumBorrowValuesFinal);assert(err==Error.NO_ERROR);return(Error.NO_ERROR,result,Exp({mantissa:0}));}}functioncalculateAccountValuesInternal(addressuserAddress)internalviewreturns(Error,uint,uint){AccountValueLocalVarsmemorylocalResults;localResults.sumSupplies=Exp({mantissa:0});localResults.sumBorrows=Exp({mantissa:0});Errorerr;localResults.collateralMarketsLength=collateralMarkets.length;for(uinti=0;i<localResults.collateralMarketsLength;i++){localResults.assetAddress=collateralMarkets[i];MarketstoragecurrentMarket=markets[localResults.assetAddress];BalancestoragesupplyBalance=supplyBalances[userAddress][localResults.assetAddress];BalancestorageborrowBalance=borrowBalances[userAddress][localResults.assetAddress];if(supplyBalance.principal>0){(err,localResults.newSupplyIndex)=calculateInterestIndex(currentMarket.supplyIndex,currentMarket.supplyRateMantissa,currentMarket.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){return(err,0,0);}(err,localResults.userSupplyCurrent)=calculateBalance(supplyBalance.principal,supplyBalance.interestIndex,localResults.newSupplyIndex);if(err!=Error.NO_ERROR){return(err,0,0);}(err,localResults.supplyTotalValue)=getPriceForAssetAmount(localResults.assetAddress,localResults.userSupplyCurrent);if(err!=Error.NO_ERROR){return(err,0,0);}(err,localResults.sumSupplies)=addExp(localResults.supplyTotalValue,localResults.sumSupplies);if(err!=Error.NO_ERROR){return(err,0,0);}}if(borrowBalance.principal>0){(err,localResults.newBorrowIndex)=calculateInterestIndex(currentMarket.borrowIndex,currentMarket.borrowRateMantissa,currentMarket.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){return(err,0,0);}(err,localResults.userBorrowCurrent)=calculateBalance(borrowBalance.principal,borrowBalance.interestIndex,localResults.newBorrowIndex);if(err!=Error.NO_ERROR){return(err,0,0);}(err,localResults.borrowTotalValue)=getPriceForAssetAmount(localResults.assetAddress,localResults.userBorrowCurrent);if(err!=Error.NO_ERROR){return(err,0,0);}(err,localResults.sumBorrows)=addExp(localResults.borrowTotalValue,localResults.sumBorrows);if(err!=Error.NO_ERROR){return(err,0,0);}}}return(Error.NO_ERROR,localResults.sumSupplies.mantissa,localResults.sumBorrows.mantissa);}functioncalculateAccountValues(addressuserAddress)publicviewreturns(uint,uint,uint){(Errorerr,uintsupplyValue,uintborrowValue)=calculateAccountValuesInternal(userAddress);if(err!=Error.NO_ERROR){return(uint(err),0,0);}return(0,supplyValue,borrowValue);}structPayBorrowLocalVars{uintnewBorrowIndex;uintuserBorrowCurrent;uintrepayAmount;uintuserBorrowUpdated;uintnewTotalBorrows;uintcurrentCash;uintupdatedCash;uintnewSupplyIndex;uintnewSupplyRateMantissa;uintnewBorrowRateMantissa;uintstartingBalance;}functionrepayBorrow(addressasset,uintamount)publicreturns(uint){if(paused){returnfail(Error.CONTRACT_PAUSED,FailureInfo.REPAY_BORROW_CONTRACT_PAUSED);}PayBorrowLocalVarsmemorylocalResults;Marketstoragemarket=markets[asset];BalancestorageborrowBalance=borrowBalances[msg.sender][asset];Errorerr;uintrateCalculationResultCode;(err,localResults.newBorrowIndex)=calculateInterestIndex(market.borrowIndex,market.borrowRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_NEW_BORROW_INDEX_CALCULATION_FAILED);}(err,localResults.userBorrowCurrent)=calculateBalance(borrowBalance.principal,borrowBalance.interestIndex,localResults.newBorrowIndex);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_ACCUMULATED_BALANCE_CALCULATION_FAILED);}if(amount==uint(-1)){localResults.repayAmount=min(getBalanceOf(asset,msg.sender),localResults.userBorrowCurrent);}else{localResults.repayAmount=amount;}(err,localResults.userBorrowUpdated)=sub(localResults.userBorrowCurrent,localResults.repayAmount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_NEW_TOTAL_BALANCE_CALCULATION_FAILED);}err=checkTransferIn(asset,msg.sender,localResults.repayAmount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_TRANSFER_IN_NOT_POSSIBLE);}(err,localResults.newTotalBorrows)=addThenSub(market.totalBorrows,localResults.userBorrowUpdated,borrowBalance.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_NEW_TOTAL_BORROW_CALCULATION_FAILED);}localResults.currentCash=getCash(asset);(err,localResults.updatedCash)=add(localResults.currentCash,localResults.repayAmount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_NEW_TOTAL_CASH_CALCULATION_FAILED);}(err,localResults.newSupplyIndex)=calculateInterestIndex(market.supplyIndex,market.supplyRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_NEW_SUPPLY_INDEX_CALCULATION_FAILED);}(rateCalculationResultCode,localResults.newSupplyRateMantissa)=market.interestRateModel.getSupplyRate(asset,localResults.updatedCash,localResults.newTotalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.REPAY_BORROW_NEW_SUPPLY_RATE_CALCULATION_FAILED,rateCalculationResultCode);}(rateCalculationResultCode,localResults.newBorrowRateMantissa)=market.interestRateModel.getBorrowRate(asset,localResults.updatedCash,localResults.newTotalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.REPAY_BORROW_NEW_BORROW_RATE_CALCULATION_FAILED,rateCalculationResultCode);}err=doTransferIn(asset,msg.sender,localResults.repayAmount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.REPAY_BORROW_TRANSFER_IN_FAILED);}market.blockNumber=getBlockNumber();market.totalBorrows=localResults.newTotalBorrows;market.supplyRateMantissa=localResults.newSupplyRateMantissa;market.supplyIndex=localResults.newSupplyIndex;market.borrowRateMantissa=localResults.newBorrowRateMantissa;market.borrowIndex=localResults.newBorrowIndex;localResults.startingBalance=borrowBalance.principal;borrowBalance.principal=localResults.userBorrowUpdated;borrowBalance.interestIndex=localResults.newBorrowIndex;emitBorrowRepaid(msg.sender,asset,localResults.repayAmount,localResults.startingBalance,localResults.userBorrowUpdated);returnuint(Error.NO_ERROR);}structBorrowLocalVars{uintnewBorrowIndex;uintuserBorrowCurrent;uintborrowAmountWithFee;uintuserBorrowUpdated;uintnewTotalBorrows;uintcurrentCash;uintupdatedCash;uintnewSupplyIndex;uintnewSupplyRateMantissa;uintnewBorrowRateMantissa;uintstartingBalance;ExpaccountLiquidity;ExpaccountShortfall;ExpethValueOfBorrowAmountWithFee;}structLiquidateLocalVars{addresstargetAccount;addressassetBorrow;addressliquidator;addressassetCollateral;uintnewBorrowIndex_UnderwaterAsset;uintnewSupplyIndex_UnderwaterAsset;uintnewBorrowIndex_CollateralAsset;uintnewSupplyIndex_CollateralAsset;uintcurrentBorrowBalance_TargetUnderwaterAsset;uintupdatedBorrowBalance_TargetUnderwaterAsset;uintnewTotalBorrows_ProtocolUnderwaterAsset;uintstartingBorrowBalance_TargetUnderwaterAsset;uintstartingSupplyBalance_TargetCollateralAsset;uintstartingSupplyBalance_LiquidatorCollateralAsset;uintcurrentSupplyBalance_TargetCollateralAsset;uintupdatedSupplyBalance_TargetCollateralAsset;uintcurrentSupplyBalance_LiquidatorCollateralAsset;uintupdatedSupplyBalance_LiquidatorCollateralAsset;uintnewTotalSupply_ProtocolCollateralAsset;uintcurrentCash_ProtocolUnderwaterAsset;uintupdatedCash_ProtocolUnderwaterAsset;uintnewSupplyRateMantissa_ProtocolUnderwaterAsset;uintnewBorrowRateMantissa_ProtocolUnderwaterAsset;uintdiscountedRepayToEvenAmount;uintdiscountedBorrowDenominatedCollateral;uintmaxCloseableBorrowAmount_TargetUnderwaterAsset;uintcloseBorrowAmount_TargetUnderwaterAsset;uintseizeSupplyAmount_TargetCollateralAsset;ExpcollateralPrice;ExpunderwaterAssetPrice;}functionliquidateBorrow(addresstargetAccount,addressassetBorrow,addressassetCollateral,uintrequestedAmountClose)publicreturns(uint){if(paused){returnfail(Error.CONTRACT_PAUSED,FailureInfo.LIQUIDATE_CONTRACT_PAUSED);}LiquidateLocalVarsmemorylocalResults;localResults.targetAccount=targetAccount;localResults.assetBorrow=assetBorrow;localResults.liquidator=msg.sender;localResults.assetCollateral=assetCollateral;MarketstorageborrowMarket=markets[assetBorrow];MarketstoragecollateralMarket=markets[assetCollateral];BalancestorageborrowBalance_TargeUnderwaterAsset=borrowBalances[targetAccount][assetBorrow];BalancestoragesupplyBalance_TargetCollateralAsset=supplyBalances[targetAccount][assetCollateral];BalancestoragesupplyBalance_LiquidatorCollateralAsset=supplyBalances[localResults.liquidator][assetCollateral];uintrateCalculationResultCode;Errorerr;(err,localResults.collateralPrice)=fetchAssetPrice(assetCollateral);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_FETCH_ASSET_PRICE_FAILED);}(err,localResults.underwaterAssetPrice)=fetchAssetPrice(assetBorrow);assert(err==Error.NO_ERROR);(err,localResults.newBorrowIndex_UnderwaterAsset)=calculateInterestIndex(borrowMarket.borrowIndex,borrowMarket.borrowRateMantissa,borrowMarket.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_BORROW_INDEX_CALCULATION_FAILED_BORROWED_ASSET);}(err,localResults.currentBorrowBalance_TargetUnderwaterAsset)=calculateBalance(borrowBalance_TargeUnderwaterAsset.principal,borrowBalance_TargeUnderwaterAsset.interestIndex,localResults.newBorrowIndex_UnderwaterAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_ACCUMULATED_BORROW_BALANCE_CALCULATION_FAILED);}(err,localResults.newSupplyIndex_CollateralAsset)=calculateInterestIndex(collateralMarket.supplyIndex,collateralMarket.supplyRateMantissa,collateralMarket.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_SUPPLY_INDEX_CALCULATION_FAILED_COLLATERAL_ASSET);}(err,localResults.currentSupplyBalance_TargetCollateralAsset)=calculateBalance(supplyBalance_TargetCollateralAsset.principal,supplyBalance_TargetCollateralAsset.interestIndex,localResults.newSupplyIndex_CollateralAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_ACCUMULATED_SUPPLY_BALANCE_CALCULATION_FAILED_BORROWER_COLLATERAL_ASSET);}(err,localResults.currentSupplyBalance_LiquidatorCollateralAsset)=calculateBalance(supplyBalance_LiquidatorCollateralAsset.principal,supplyBalance_LiquidatorCollateralAsset.interestIndex,localResults.newSupplyIndex_CollateralAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_ACCUMULATED_SUPPLY_BALANCE_CALCULATION_FAILED_LIQUIDATOR_COLLATERAL_ASSET);}(err,localResults.newTotalSupply_ProtocolCollateralAsset)=addThenSub(collateralMarket.totalSupply,localResults.currentSupplyBalance_TargetCollateralAsset,supplyBalance_TargetCollateralAsset.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_TOTAL_SUPPLY_BALANCE_CALCULATION_FAILED_BORROWER_COLLATERAL_ASSET);}(err,localResults.newTotalSupply_ProtocolCollateralAsset)=addThenSub(localResults.newTotalSupply_ProtocolCollateralAsset,localResults.currentSupplyBalance_LiquidatorCollateralAsset,supplyBalance_LiquidatorCollateralAsset.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_TOTAL_SUPPLY_BALANCE_CALCULATION_FAILED_LIQUIDATOR_COLLATERAL_ASSET);}(err,localResults.discountedBorrowDenominatedCollateral)=calculateDiscountedBorrowDenominatedCollateral(localResults.underwaterAssetPrice,localResults.collateralPrice,localResults.currentSupplyBalance_TargetCollateralAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_BORROW_DENOMINATED_COLLATERAL_CALCULATION_FAILED);}if(borrowMarket.isSupported){(err,localResults.discountedRepayToEvenAmount)=calculateDiscountedRepayToEvenAmount(targetAccount,localResults.underwaterAssetPrice);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_DISCOUNTED_REPAY_TO_EVEN_AMOUNT_CALCULATION_FAILED);}localResults.maxCloseableBorrowAmount_TargetUnderwaterAsset=min(localResults.currentBorrowBalance_TargetUnderwaterAsset,localResults.discountedBorrowDenominatedCollateral);localResults.maxCloseableBorrowAmount_TargetUnderwaterAsset=min(localResults.maxCloseableBorrowAmount_TargetUnderwaterAsset,localResults.discountedRepayToEvenAmount);}else{localResults.maxCloseableBorrowAmount_TargetUnderwaterAsset=min(localResults.currentBorrowBalance_TargetUnderwaterAsset,localResults.discountedBorrowDenominatedCollateral);}if(requestedAmountClose==uint(-1)){localResults.closeBorrowAmount_TargetUnderwaterAsset=localResults.maxCloseableBorrowAmount_TargetUnderwaterAsset;}else{localResults.closeBorrowAmount_TargetUnderwaterAsset=requestedAmountClose;}if(localResults.closeBorrowAmount_TargetUnderwaterAsset>localResults.maxCloseableBorrowAmount_TargetUnderwaterAsset){returnfail(Error.INVALID_CLOSE_AMOUNT_REQUESTED,FailureInfo.LIQUIDATE_CLOSE_AMOUNT_TOO_HIGH);}(err,localResults.seizeSupplyAmount_TargetCollateralAsset)=calculateAmountSeize(localResults.underwaterAssetPrice,localResults.collateralPrice,localResults.closeBorrowAmount_TargetUnderwaterAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_AMOUNT_SEIZE_CALCULATION_FAILED);}err=checkTransferIn(assetBorrow,localResults.liquidator,localResults.closeBorrowAmount_TargetUnderwaterAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_TRANSFER_IN_NOT_POSSIBLE);}(err,localResults.updatedBorrowBalance_TargetUnderwaterAsset)=sub(localResults.currentBorrowBalance_TargetUnderwaterAsset,localResults.closeBorrowAmount_TargetUnderwaterAsset);assert(err==Error.NO_ERROR);(err,localResults.newTotalBorrows_ProtocolUnderwaterAsset)=addThenSub(borrowMarket.totalBorrows,localResults.updatedBorrowBalance_TargetUnderwaterAsset,borrowBalance_TargeUnderwaterAsset.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_TOTAL_BORROW_CALCULATION_FAILED_BORROWED_ASSET);}localResults.currentCash_ProtocolUnderwaterAsset=getCash(assetBorrow);(err,localResults.updatedCash_ProtocolUnderwaterAsset)=add(localResults.currentCash_ProtocolUnderwaterAsset,localResults.closeBorrowAmount_TargetUnderwaterAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_TOTAL_CASH_CALCULATION_FAILED_BORROWED_ASSET);}(err,localResults.newSupplyIndex_UnderwaterAsset)=calculateInterestIndex(borrowMarket.supplyIndex,borrowMarket.supplyRateMantissa,borrowMarket.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_SUPPLY_INDEX_CALCULATION_FAILED_BORROWED_ASSET);}(rateCalculationResultCode,localResults.newSupplyRateMantissa_ProtocolUnderwaterAsset)=borrowMarket.interestRateModel.getSupplyRate(assetBorrow,localResults.updatedCash_ProtocolUnderwaterAsset,localResults.newTotalBorrows_ProtocolUnderwaterAsset);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.LIQUIDATE_NEW_SUPPLY_RATE_CALCULATION_FAILED_BORROWED_ASSET,rateCalculationResultCode);}(rateCalculationResultCode,localResults.newBorrowRateMantissa_ProtocolUnderwaterAsset)=borrowMarket.interestRateModel.getBorrowRate(assetBorrow,localResults.updatedCash_ProtocolUnderwaterAsset,localResults.newTotalBorrows_ProtocolUnderwaterAsset);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.LIQUIDATE_NEW_BORROW_RATE_CALCULATION_FAILED_BORROWED_ASSET,rateCalculationResultCode);}(err,localResults.newBorrowIndex_CollateralAsset)=calculateInterestIndex(collateralMarket.borrowIndex,collateralMarket.borrowRateMantissa,collateralMarket.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_NEW_BORROW_INDEX_CALCULATION_FAILED_COLLATERAL_ASSET);}(err,localResults.updatedSupplyBalance_TargetCollateralAsset)=sub(localResults.currentSupplyBalance_TargetCollateralAsset,localResults.seizeSupplyAmount_TargetCollateralAsset);assert(err==Error.NO_ERROR);(err,localResults.updatedSupplyBalance_LiquidatorCollateralAsset)=add(localResults.currentSupplyBalance_LiquidatorCollateralAsset,localResults.seizeSupplyAmount_TargetCollateralAsset);assert(err==Error.NO_ERROR);err=doTransferIn(assetBorrow,localResults.liquidator,localResults.closeBorrowAmount_TargetUnderwaterAsset);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.LIQUIDATE_TRANSFER_IN_FAILED);}borrowMarket.blockNumber=getBlockNumber();borrowMarket.totalBorrows=localResults.newTotalBorrows_ProtocolUnderwaterAsset;borrowMarket.supplyRateMantissa=localResults.newSupplyRateMantissa_ProtocolUnderwaterAsset;borrowMarket.supplyIndex=localResults.newSupplyIndex_UnderwaterAsset;borrowMarket.borrowRateMantissa=localResults.newBorrowRateMantissa_ProtocolUnderwaterAsset;borrowMarket.borrowIndex=localResults.newBorrowIndex_UnderwaterAsset;collateralMarket.blockNumber=getBlockNumber();collateralMarket.totalSupply=localResults.newTotalSupply_ProtocolCollateralAsset;collateralMarket.supplyIndex=localResults.newSupplyIndex_CollateralAsset;collateralMarket.borrowIndex=localResults.newBorrowIndex_CollateralAsset;localResults.startingBorrowBalance_TargetUnderwaterAsset=borrowBalance_TargeUnderwaterAsset.principal;borrowBalance_TargeUnderwaterAsset.principal=localResults.updatedBorrowBalance_TargetUnderwaterAsset;borrowBalance_TargeUnderwaterAsset.interestIndex=localResults.newBorrowIndex_UnderwaterAsset;localResults.startingSupplyBalance_TargetCollateralAsset=supplyBalance_TargetCollateralAsset.principal;supplyBalance_TargetCollateralAsset.principal=localResults.updatedSupplyBalance_TargetCollateralAsset;supplyBalance_TargetCollateralAsset.interestIndex=localResults.newSupplyIndex_CollateralAsset;localResults.startingSupplyBalance_LiquidatorCollateralAsset=supplyBalance_LiquidatorCollateralAsset.principal;supplyBalance_LiquidatorCollateralAsset.principal=localResults.updatedSupplyBalance_LiquidatorCollateralAsset;supplyBalance_LiquidatorCollateralAsset.interestIndex=localResults.newSupplyIndex_CollateralAsset;emitLiquidationEvent(localResults);returnuint(Error.NO_ERROR);}functionemitLiquidationEvent(LiquidateLocalVarsmemorylocalResults)internal{emitBorrowLiquidated(localResults.targetAccount,localResults.assetBorrow,localResults.startingBorrowBalance_TargetUnderwaterAsset,localResults.currentBorrowBalance_TargetUnderwaterAsset,localResults.closeBorrowAmount_TargetUnderwaterAsset,localResults.updatedBorrowBalance_TargetUnderwaterAsset,localResults.liquidator,localResults.assetCollateral,localResults.startingSupplyBalance_TargetCollateralAsset,localResults.currentSupplyBalance_TargetCollateralAsset,localResults.seizeSupplyAmount_TargetCollateralAsset,localResults.updatedSupplyBalance_TargetCollateralAsset);}functioncalculateDiscountedRepayToEvenAmount(addresstargetAccount,ExpmemoryunderwaterAssetPrice)internalviewreturns(Error,uint){Errorerr;Expmemory_accountLiquidity;ExpmemoryaccountShortfall_TargetUser;ExpmemorycollateralRatioMinusLiquidationDiscount;ExpmemorydiscountedCollateralRatioMinusOne;ExpmemorydiscountedPrice_UnderwaterAsset;ExpmemoryrawResult;(err,_accountLiquidity,accountShortfall_TargetUser)=calculateAccountLiquidity(targetAccount);if(err!=Error.NO_ERROR){return(err,0);}(err,collateralRatioMinusLiquidationDiscount)=subExp(collateralRatio,liquidationDiscount);if(err!=Error.NO_ERROR){return(err,0);}(err,discountedCollateralRatioMinusOne)=subExp(collateralRatioMinusLiquidationDiscount,Exp({mantissa:mantissaOne}));if(err!=Error.NO_ERROR){return(err,0);}(err,discountedPrice_UnderwaterAsset)=mulExp(underwaterAssetPrice,discountedCollateralRatioMinusOne);assert(err==Error.NO_ERROR);(err,rawResult)=divExp(accountShortfall_TargetUser,discountedPrice_UnderwaterAsset);if(err!=Error.NO_ERROR){return(err,0);}return(Error.NO_ERROR,truncate(rawResult));}functioncalculateDiscountedBorrowDenominatedCollateral(ExpmemoryunderwaterAssetPrice,ExpmemorycollateralPrice,uintsupplyCurrent_TargetCollateralAsset)viewinternalreturns(Error,uint){Errorerr;ExpmemoryonePlusLiquidationDiscount;ExpmemorysupplyCurrentTimesOracleCollateral;ExpmemoryonePlusLiquidationDiscountTimesOracleBorrow;ExpmemoryrawResult;(err,onePlusLiquidationDiscount)=addExp(Exp({mantissa:mantissaOne}),liquidationDiscount);if(err!=Error.NO_ERROR){return(err,0);}(err,supplyCurrentTimesOracleCollateral)=mulScalar(collateralPrice,supplyCurrent_TargetCollateralAsset);if(err!=Error.NO_ERROR){return(err,0);}(err,onePlusLiquidationDiscountTimesOracleBorrow)=mulExp(onePlusLiquidationDiscount,underwaterAssetPrice);if(err!=Error.NO_ERROR){return(err,0);}(err,rawResult)=divExp(supplyCurrentTimesOracleCollateral,onePlusLiquidationDiscountTimesOracleBorrow);if(err!=Error.NO_ERROR){return(err,0);}return(Error.NO_ERROR,truncate(rawResult));}functioncalculateAmountSeize(ExpmemoryunderwaterAssetPrice,ExpmemorycollateralPrice,uintcloseBorrowAmount_TargetUnderwaterAsset)internalviewreturns(Error,uint){Errorerr;ExpmemoryliquidationMultiplier;ExpmemorypriceUnderwaterAssetTimesLiquidationMultiplier;ExpmemoryfinalNumerator;ExpmemoryrawResult;(err,liquidationMultiplier)=addExp(Exp({mantissa:mantissaOne}),liquidationDiscount);assert(err==Error.NO_ERROR);(err,priceUnderwaterAssetTimesLiquidationMultiplier)=mulExp(underwaterAssetPrice,liquidationMultiplier);if(err!=Error.NO_ERROR){return(err,0);}(err,finalNumerator)=mulScalar(priceUnderwaterAssetTimesLiquidationMultiplier,closeBorrowAmount_TargetUnderwaterAsset);if(err!=Error.NO_ERROR){return(err,0);}(err,rawResult)=divExp(finalNumerator,collateralPrice);if(err!=Error.NO_ERROR){return(err,0);}return(Error.NO_ERROR,truncate(rawResult));}functionborrow(addressasset,uintamount)publicreturns(uint){if(paused){returnfail(Error.CONTRACT_PAUSED,FailureInfo.BORROW_CONTRACT_PAUSED);}BorrowLocalVarsmemorylocalResults;Marketstoragemarket=markets[asset];BalancestorageborrowBalance=borrowBalances[msg.sender][asset];Errorerr;uintrateCalculationResultCode;if(!market.isSupported){returnfail(Error.MARKET_NOT_SUPPORTED,FailureInfo.BORROW_MARKET_NOT_SUPPORTED);}(err,localResults.newBorrowIndex)=calculateInterestIndex(market.borrowIndex,market.borrowRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_NEW_BORROW_INDEX_CALCULATION_FAILED);}(err,localResults.userBorrowCurrent)=calculateBalance(borrowBalance.principal,borrowBalance.interestIndex,localResults.newBorrowIndex);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_ACCUMULATED_BALANCE_CALCULATION_FAILED);}(err,localResults.borrowAmountWithFee)=calculateBorrowAmountWithFee(amount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_ORIGINATION_FEE_CALCULATION_FAILED);}(err,localResults.userBorrowUpdated)=add(localResults.userBorrowCurrent,localResults.borrowAmountWithFee);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_NEW_TOTAL_BALANCE_CALCULATION_FAILED);}(err,localResults.newTotalBorrows)=addThenSub(market.totalBorrows,localResults.userBorrowUpdated,borrowBalance.principal);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_NEW_TOTAL_BORROW_CALCULATION_FAILED);}(err,localResults.accountLiquidity,localResults.accountShortfall)=calculateAccountLiquidity(msg.sender);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_ACCOUNT_LIQUIDITY_CALCULATION_FAILED);}if(!isZeroExp(localResults.accountShortfall)){returnfail(Error.INSUFFICIENT_LIQUIDITY,FailureInfo.BORROW_ACCOUNT_SHORTFALL_PRESENT);}(err,localResults.ethValueOfBorrowAmountWithFee)=getPriceForAssetAmountMulCollatRatio(asset,localResults.borrowAmountWithFee);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_AMOUNT_VALUE_CALCULATION_FAILED);}if(lessThanExp(localResults.accountLiquidity,localResults.ethValueOfBorrowAmountWithFee)){returnfail(Error.INSUFFICIENT_LIQUIDITY,FailureInfo.BORROW_AMOUNT_LIQUIDITY_SHORTFALL);}localResults.currentCash=getCash(asset);(err,localResults.updatedCash)=sub(localResults.currentCash,amount);if(err!=Error.NO_ERROR){returnfail(Error.TOKEN_INSUFFICIENT_CASH,FailureInfo.BORROW_NEW_TOTAL_CASH_CALCULATION_FAILED);}(err,localResults.newSupplyIndex)=calculateInterestIndex(market.supplyIndex,market.supplyRateMantissa,market.blockNumber,getBlockNumber());if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_NEW_SUPPLY_INDEX_CALCULATION_FAILED);}(rateCalculationResultCode,localResults.newSupplyRateMantissa)=market.interestRateModel.getSupplyRate(asset,localResults.updatedCash,localResults.newTotalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.BORROW_NEW_SUPPLY_RATE_CALCULATION_FAILED,rateCalculationResultCode);}(rateCalculationResultCode,localResults.newBorrowRateMantissa)=market.interestRateModel.getBorrowRate(asset,localResults.updatedCash,localResults.newTotalBorrows);if(rateCalculationResultCode!=0){returnfailOpaque(FailureInfo.BORROW_NEW_BORROW_RATE_CALCULATION_FAILED,rateCalculationResultCode);}err=doTransferOut(asset,msg.sender,amount);if(err!=Error.NO_ERROR){returnfail(err,FailureInfo.BORROW_TRANSFER_OUT_FAILED);}market.blockNumber=getBlockNumber();market.totalBorrows=localResults.newTotalBorrows;market.supplyRateMantissa=localResults.newSupplyRateMantissa;market.supplyIndex=localResults.newSupplyIndex;market.borrowRateMantissa=localResults.newBorrowRateMantissa;market.borrowIndex=localResults.newBorrowIndex;localResults.startingBalance=borrowBalance.principal;borrowBalance.principal=localResults.userBorrowUpdated;borrowBalance.interestIndex=localResults.newBorrowIndex;emitBorrowTaken(msg.sender,asset,amount,localResults.startingBalance,localResults.borrowAmountWithFee,localResults.userBorrowUpdated);returnuint(Error.NO_ERROR);}}

ruleId: SOLIDITY_OVERPOWERED_ROLE
patternId: j83hf7
severity: 2
line: 2728
column: 4
content: functionsetAllowLiquidation(boolallowLiquidation_)public{require(msg.sender==liquidator,"LIQUIDATION_CHECKER_INVALID_LIQUIDATOR");allowLiquidation=allowLiquidation_;}

ruleId: SOLIDITY_PRAGMAS_VERSION
patternId: 23fc32
severity: 1
line: 1
column: 16
content: ^

ruleId: SOLIDITY_REDUNDANT_FALLBACK_REJECT
patternId: b85a32
severity: 1
line: 686
column: 30
content: {revert();}

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 439
column: 55
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 456
column: 55
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 467
column: 55
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 478
column: 55
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 491
column: 70
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 523
column: 64
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 540
column: 70
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 549
column: 70
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 558
column: 72
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 570
column: 72
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 582
column: 76
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 602
column: 70
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 629
column: 70
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 944
column: 145
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 983
column: 122
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1000
column: 91
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1018
column: 105
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1047
column: 83
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1070
column: 66
content: (Error,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1101
column: 87
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1803
column: 82
content: (Error,Expmemory,Expmemory)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 1850
column: 87
content: (Error,uint,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 2441
column: 128
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 2485
column: 185
content: (Error,uint)

ruleId: SOLIDITY_SHOULD_RETURN_STRUCT
patternId: 7d54ca
severity: 1
line: 2521
column: 163
content: (Error,uint)

ruleId: SOLIDITY_TX_ORIGIN
patternId: 12e802
severity: 2
line: 315
column: 27
content: tx.origin

ruleId: SOLIDITY_TX_ORIGIN
patternId: 12e802
severity: 2
line: 2722
column: 55
content: tx.origin

ruleId: SOLIDITY_UPGRADE_TO_050
patternId: 91h3sa
severity: 1
line: 686
column: 23
content: public

ruleId: SOLIDITY_UPGRADE_TO_050
patternId: 341gim
severity: 1
line: 582
column: 41
content: Expdivisor

ruleId: SOLIDITY_USING_INLINE_ASSEMBLY
patternId: 109cd5
severity: 1
line: 358
column: 8
content: assembly{switchreturndatasize()case0{result:=not(0)}case32{returndatacopy(0,0,32)result:=mload(0)}default{revert(0,0)}}

ruleId: SOLIDITY_USING_INLINE_ASSEMBLY
patternId: 109cd5
severity: 1
line: 413
column: 8
content: assembly{switchreturndatasize()case0{result:=not(0)}case32{returndatacopy(0,0,32)result:=mload(0)}default{revert(0,0)}}

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 506
column: 4
content: uintconstantexpScale=10**18;

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 509
column: 4
content: uintconstanthalfExpScale=expScale/2;

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 515
column: 4
content: uintconstantmantissaOne=10**18;

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 516
column: 4
content: uintconstantmantissaOneTenth=10**17;

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 666
column: 4
content: uintconstantinitialInterestIndex=10**18;

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 667
column: 4
content: uintconstantdefaultOriginationFee=0;

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 669
column: 4
content: uintconstantminimumCollateralRatioMantissa=11*(10**17);

ruleId: SOLIDITY_VISIBILITY
patternId: b51ce0
severity: 1
line: 670
column: 4
content: uintconstantmaximumLiquidationDiscountMantissa=(10**17);

SOLIDITY_VISIBILITY :8
SOLIDITY_OVERPOWERED_ROLE :1
SOLIDITY_PRAGMAS_VERSION :1
SOLIDITY_LOCKED_MONEY :1
SOLIDITY_EXTRA_GAS_IN_LOOPS :1
SOLIDITY_ADDRESS_HARDCODED :1
SOLIDITY_UPGRADE_TO_050 :2
SOLIDITY_GAS_LIMIT_IN_LOOPS :1
SOLIDITY_USING_INLINE_ASSEMBLY :2
SOLIDITY_SHOULD_RETURN_STRUCT :25
SOLIDITY_REDUNDANT_FALLBACK_REJECT :1
SOLIDITY_TX_ORIGIN :2